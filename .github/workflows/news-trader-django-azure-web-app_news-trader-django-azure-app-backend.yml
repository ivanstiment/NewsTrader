# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
# More info on Python, GitHub Actions, and Azure App Service: https://aka.ms/python-webapps-actions

name: Build and deploy Python app to Azure Web App - news-trader-django-azure-app-backend

env:
  DEBUG: False
  DJANGO_PRODUCTION: 1
  DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
  DBUSER: ${{ secrets.DBUSER }}
  DBPASS: ${{ secrets.DBPASS }}
  DBNAME: ${{ secrets.DBNAME }}
  DBHOST: ${{ secrets.DBHOST }}
  CELERY_RESULT_BACKEND: ${{ secrets.CELERY_RESULT_BACKEND }}
  CELERY_BROKER_URL: ${{ secrets.CELERY_BROKER_URL }}
  WEBSITE_HOSTNAME: ${{ vars.WEBSITE_HOSTNAME }}
  FRONTEND_URL: ${{ vars.FRONTEND_URL }}
  VITE_API_BASE_URL_PROD: ${{ secrets.VITE_API_BASE_URL_PROD }}

on:
  push:
    branches:
      - news-trader-django-azure-web-app
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python version
        uses: actions/setup-python@v5
        with:
          python-version: "3.13.3"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Clean residual Python files
        run: |
          echo "ðŸ§¹ Limpiando archivos .pyc y __pycache__..."
          find . -name "*.pyc" -exec rm -f {} +
          find . -name "__pycache__" -type d -exec rm -rf {} +
          echo "ðŸ§¹ Eliminando db.sqlite3 si existe..."
          find . -name "db.sqlite3" -exec rm -f {} + || true

      - name: Setup WebJob with Oryx-compatible structure
        run: |
          echo "ðŸ”§ Configurando WebJob compatible con Oryx..."
          
          # Crear estructura de carpetas para WebJob
          mkdir -p App_Data/jobs/continuous/celeryworker
          
          # Crear script de inicio que funciona con la estructura real de Oryx
          cat > App_Data/jobs/continuous/celeryworker/run.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "=== WebJob Celery Worker - Inicio ==="
          echo "Timestamp: $(date)"
          echo "Directorio actual: $(pwd)"
          echo "Usuario: $(whoami)"
          echo ""
          
          echo "ðŸ” DiagnÃ³stico completo del entorno:"
          echo "PATH: $PATH"
          echo "PYTHONPATH: $PYTHONPATH" 
          echo "WEBSITE_SITE_NAME: $WEBSITE_SITE_NAME"
          echo "HOME: $HOME"
          echo "PWD: $PWD"
          echo ""
          
          # Buscar directorios temporales de Oryx
          echo "ðŸ” Buscando directorios de aplicaciÃ³n de Oryx..."
          find /tmp -maxdepth 1 -name "*" -type d 2>/dev/null | grep -E "/tmp/[a-f0-9]+" || echo "No se encontraron directorios Oryx"
          echo ""
          
          # Encontrar el directorio correcto donde Oryx extrajo la aplicaciÃ³n
          APP_DIR=""
          for dir in /tmp/*/; do
              if [ -d "${dir}news_trader" ] && [ -d "${dir}antenv" ]; then
                  APP_DIR="$dir"
                  echo "âœ… Encontrado directorio de aplicaciÃ³n: $APP_DIR"
                  break
              fi
          done
          
          if [ -z "$APP_DIR" ]; then
              echo "âŒ Error: No se encontrÃ³ directorio de aplicaciÃ³n con news_trader y antenv"
              echo "ðŸ“ Explorando /tmp para diagnÃ³stico:"
              ls -la /tmp/
              echo ""
              echo "ðŸ“ Contenido de /home/site/wwwroot:"
              ls -la /home/site/wwwroot/
              exit 1
          fi
          
          echo "ðŸ“‚ Cambiando al directorio de aplicaciÃ³n: $APP_DIR"
          cd "$APP_DIR"
          
          echo "ðŸ“ Contenido del directorio de aplicaciÃ³n:"
          ls -la
          echo ""
          
          # Verificar estructura necesaria
          if [ ! -d "news_trader" ]; then
              echo "âŒ Error: Directorio news_trader no encontrado"
              exit 1
          fi
          
          if [ ! -d "antenv" ]; then
              echo "âŒ Error: Entorno virtual antenv no encontrado"
              exit 1
          fi
          
          echo "âœ… Estructura de aplicaciÃ³n verificada"
          
          # NO necesitamos modificar DJANGO_SETTINGS_MODULE ni PYTHONPATH
          # Oryx ya los configurÃ³ correctamente
          
          echo "ðŸ InformaciÃ³n de Python:"
          python --version
          echo "PYTHONPATH actual: $PYTHONPATH"
          echo ""
          
          # Verificar variables de entorno necesarias para Celery
          if [ -z "$CELERY_BROKER_URL" ]; then
              echo "âš ï¸  ADVERTENCIA: CELERY_BROKER_URL no estÃ¡ configurada"
          else
              echo "âœ… CELERY_BROKER_URL configurada"
          fi
          
          if [ -z "$CELERY_RESULT_BACKEND" ]; then
              echo "âš ï¸  ADVERTENCIA: CELERY_RESULT_BACKEND no estÃ¡ configurada"
          else
              echo "âœ… CELERY_RESULT_BACKEND configurada"
          fi
          echo ""
          
          # Verificar imports crÃ­ticos
          echo "ðŸ§ª Verificando imports..."
          python -c "
          try:
              import news_trader
              print('âœ… news_trader importado correctamente')
          except ImportError as e:
              print(f'âŒ Error importando news_trader: {e}')
              import sys
              print(f'sys.path: {sys.path}')
              exit(1)
          
          try:
              import celery
              print(f'âœ… Celery version: {celery.__version__}')
          except ImportError as e:
              print(f'âŒ Error importando Celery: {e}')
              exit(1)
          
          # Verificar que podemos crear la instancia de Celery
          try:
              from news_trader.celery import app
              print('âœ… Instancia de Celery accesible')
          except Exception as e:
              print(f'âš ï¸  Advertencia al acceder a instancia Celery: {e}')
          "
          
          if [ $? -ne 0 ]; then
              echo "âŒ Error en verificaciÃ³n de imports"
              exit 1
          fi
          
          echo ""
          echo "ðŸš€ Iniciando Celery Worker..."
          echo "Comando: python -m celery -A news_trader worker --loglevel=INFO"
          echo ""
          
          # Ejecutar Celery - versiÃ³n simplificada para debugging inicial
          exec python -m celery -A news_trader worker \
            --loglevel=INFO \
            --concurrency=1 \
            --events
          EOF
          
          # Hacer el script ejecutable
          chmod +x App_Data/jobs/continuous/celeryworker/run.sh
          
          # ConfiguraciÃ³n del WebJob optimizada
          cat > App_Data/jobs/continuous/celeryworker/settings.job << 'EOF'
          {
              "is_continuous": true,
              "stopping_wait_time": 90,
              "using_sdk": false,
              "singleton": true
          }
          EOF
          
          echo "âœ… WebJob configurado para compatibilidad con Oryx"

      - name: Crear directorios estÃ¡ticos si no existen
        run: |
          mkdir -p ${{ github.workspace }}/staticfiles
          mkdir -p ${{ github.workspace }}/static

      - name: Collect static files
        run: python manage.py collectstatic --no-input

      # Optional: Add step to run tests here (PyTest, Django test suites, etc.)

      - name: Verify WebJob files before packaging
        run: |
          echo "ðŸ” Verificando archivos del WebJob..."
          echo "Estructura App_Data:"
          find App_Data -type f -exec ls -la {} \;
          echo ""
          echo "ðŸ“„ Contenido run.sh:"
          cat App_Data/jobs/continuous/celeryworker/run.sh | head -30
          echo "... (script truncado para brevedad)"
          echo ""
          echo "ðŸ“„ Contenido settings.job:"
          cat App_Data/jobs/continuous/celeryworker/settings.job

      - name: Zip artifact for deployment excluding unnecessary folders
        run: |
          echo "ðŸ“¦ Creando paquete de deployment..."
          zip -r release.zip . -x \
            "*.venv*" \
            "*.git*" \
            "*__pycache__*" \
            "*.pytest_cache*" \
            "*.coverage*" \
            "*node_modules*" \
            "*.env*"

      - name: Verify package contents
        run: |
          echo "ðŸ” Verificando contenido del paquete..."
          echo "Archivos del WebJob en el zip:"
          unzip -l release.zip | grep -E "(App_Data|celery)" || echo "âŒ No se encontraron archivos del WebJob"
          echo ""
          echo "TamaÃ±o del paquete:"
          ls -lh release.zip

      - name: Upload artifact for deployment jobs
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: release.zip

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: "Production"
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: python-app

      - name: Unzip artifact for deployment
        run: |
          echo "ðŸ“‚ Descomprimiendo artefacto..."
          unzip release.zip
          echo "âœ… Artefacto descomprimido"

      - name: Final verification before deployment
        run: |
          echo "ðŸ” VerificaciÃ³n final antes del deploy..."
          if [ -d "App_Data/jobs/continuous/celeryworker" ]; then
              echo "âœ… Directorio del WebJob encontrado"
              ls -la App_Data/jobs/continuous/celeryworker/
          else
              echo "âŒ Directorio del WebJob NO encontrado"
              exit 1
          fi

      - name: "Deploy to Azure Web App"
        uses: azure/webapps-deploy@v3
        id: deploy-to-webapp
        with:
          app-name: "news-trader-django-azure-app-backend"
          slot-name: "Production"
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_BC4BA36656BF4F048A4F89E646E56639 }}
          package: '.'
          clean: false